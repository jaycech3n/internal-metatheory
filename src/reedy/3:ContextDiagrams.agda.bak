{-# OPTIONS --without-K --rewriting #-}

open import cwfs.CwFs
open import cwfs.Pi
open import cwfs.Universe
open import reedy.IndexSemicategories

module reedy.ContextDiagrams {â„“â‚˜á´µ â„“â‚’ â„“â‚˜}
  (I : SuitableSemicategory â„“â‚˜á´µ)
  {C : WildCategory â„“â‚’ â„“â‚˜}
  (cwfstr : CwFStructure C)
  (pistr : PiStructure cwfstr)
  (univstr : UniverseStructure cwfstr)
  where

open import reedy.LinearSieves I
open SuitableSemicategory I
open CwFStructure cwfstr renaming (_â—¦_ to _â—¦Ë¢áµ˜áµ‡_)
open PiStructure pistr
open UniverseStructure univstr

SCT : â„• â†’ Con
F : (n : â„•) â†’ Ty (SCT n)
M_[_,_,_] : (n i h t : â„•) â†’ is-shape i h t â†’ h < n â†’ Con
Mâƒ—_[_,_,_] :
  (n i h t : â„•) (iS : is-shape i h t) (u : h < n)
  {m : â„•} (f : hom i m)
  {iSÂ· : is-shape-Î£ ([ i , h , t ] iS Â· f)}
  {uÂ· : 2nd ([ i , h , t ] iS Â· f) < n}
  â†’ let s = [ i , h , t ] iS Â· f in
    Sub (M n [ i , h , t ] iS u)
        (M n [ fst s , 2nd s , 3rd s ] iSÂ· uÂ·)
Î â€²â‹†_[_,_,_]â†’[_,_] : âˆ€ n i h t h' t' iS u iS' u'
  â†’ [ i , h' , t' ]â‰¤â‚›[ h , t ]
  â†’ Ty (M n [ i , h , t ] iS u) â†’ Ty (M n [ i , h' , t' ] iS' u')
-- Projection from larger to smaller matching context drops components
Ï€â‹†á´¹ : âˆ€ n i {h t h' t'} iS iS' u u'
  â†’ [ i , h' , t' ]â‰¤â‚›[ h , t ]
  â†’ Sub (M n [ i , h , t ] iS u) (M n [ i , h' , t' ] iS' u')
-- Drops higher dimensional fillers
Ï€â‹†Ë¢ : âˆ€ n h â†’ h < n â†’ Sub (SCT n) (SCT h)
ð“ : âˆ€ n h u â†’ Tm[ SCT n ] (F h [ Ï€â‹†Ë¢ n h u ])

SCT O = â—†
SCT (1+ n) = SCT n âˆ· F n

-- Not sure if the following formulation of Ï€â‹†Ë¢ and ð“ will work with the other parts
-- later, but let's just do it and see.
Ï€â‹†Ë¢ .(1+ h) h ltS = Ï€ (F h)
Ï€â‹†Ë¢ (1+ n) h (ltSR u) = Ï€â‹†Ë¢ n h u â—¦Ë¢áµ˜áµ‡ Ï€ (F n)

ð“ .(1+ h) h ltS = Ï… (F h)
ð“ (1+ n) h (ltSR u) = ð“ n h u Ê·â‚œ â—‚$ coeáµ€áµ (! [â—¦])

-- The following PROBLEMs document why defining F as in this file doesn't seem to
-- work.
M n [ i , O , O ] iS u = SCT n
M n [ i , O , 1+ t ] iS u = M n [ i , O , t ] (shapeâ‚œâ†“ iS) u âˆ· {!Aâ‚€
  -- PROBLEM 1: giving this here results in termination errors.!}
  where
  Ï€â‹† : Sub (M n [ i , O , t ] (shapeâ‚œâ†“ iS) u) (SCT n)
  Ï€â‹† = Ï€â‹†á´¹ n i (shapeâ‚œâ†“ iS) (empty-shape i) u u (OO[â‰¤â‚›] (shapeâ‚œâ†“ iS))
  Aâ‚€ : Ty (M n [ i , O , t ] (shapeâ‚œâ†“ iS) u)
  Aâ‚€ = el (ð“ n O u [ Ï€â‹† ]â‚œ â—‚$ coeáµ€áµ (! [â—¦] âˆ™ {!U[]
       -- PROBLEM 2: At this point, F is not defined and F O is not definitionally
       -- equal to U. But the definition of F also needs a definitional equality
       -- on M to hold for it to typecheck.!}))
M n [ i , 1+ h , O ] iS u = M n [ i , h , hom-size i h ] (shapeâ‚•â†“ iS) (S<-< u)
M n [ i , 1+ h , 1+ t ] iS u = M n [ i , 1+ h , t ] (shapeâ‚œâ†“ iS) u
  âˆ· {!ð“ n (1+ h) u -- un-Î 'â‹† the preceding, then substitute!}

Mâƒ— n [ i , h , t ] iS u f = {!!}

Î â€²â‹† n [ i , h , t ]â†’[ .h , .t ] iS u iS' u' done A
  rewrite shape= iS' iS | <= u' u = A
Î â€²â‹† n [ i , O , t ]â†’[ .O , t' ] iS u iS' u' (on-width v w) A
  rewrite shape= iS' (shapeâ‚œâ†“ $ shape-conds (hcond iS') (â‰¤-trans (<-Sâ‰¤ v) (tcond iS)))
  = Î â€² _ (Î â€²â‹† n [ i , O , t ]â†’[ O , 1+ t' ] iS u iS'' u' w A)
    where
    iS'' : is-shape i O (1+ t')
    iS'' = shape-conds (hcond iS') (â‰¤-trans (<-Sâ‰¤ v) (tcond iS))
Î â€²â‹† n [ i , 1+ h , t ]â†’[ .(1+ h) , t' ] iS u iS' u' (on-width v w) A
  rewrite shape= iS' (shapeâ‚œâ†“ $ shape-conds (hcond iS') (â‰¤-trans (<-Sâ‰¤ v) (tcond iS)))
  = Î â€² _ (Î â€²â‹† n [ i , 1+ h , t ]â†’[ 1+ h , 1+ t' ] iS u iS'' u' w A)
    where
    iS'' : is-shape i (1+ h) (1+ t')
    iS'' = shape-conds (hcond iS') (â‰¤-trans (<-Sâ‰¤ v) (tcond iS))
Î â€²â‹† n [ i , h , t ]â†’[ h' , .(hom-size i h') ] iS u iS' u' (on-height-width-max v w) A
  rewrite shape= iS' (shapeâ‚•â†“ (new-level i (1+ h') (â‰¤-trans (<-Sâ‰¤ v) (hcond iS))))
        | <= u' (S<-< (â‰¤-<-< (<-Sâ‰¤ v) u))
  = Î â€²â‹† n [ i , h , t ]â†’[ 1+ h' , O ] iS u iS'' v' w A
    where
    iS'' : is-shape i (1+ h') O
    iS'' = new-level i (1+ h') (â‰¤-trans (<-Sâ‰¤ v) (hcond iS))
    v' : 1+ h' < n
    v' = â‰¤-<-< (<-Sâ‰¤ v) u
Î â€²â‹† n [ i , h , t ]â†’[ O , t' ] iS u iS' u' (on-height-width<max v v' w) A
  rewrite shape= iS' (shapeâ‚œâ†“ $ shape-conds (hcond iS') (<-Sâ‰¤ v'))
  = Î â€² _ (Î â€²â‹† n [ i , h , t ]â†’[ O , 1+ t' ] iS u iS'' u' w A)
    where
    iS'' : is-shape i O (1+ t')
    iS'' = shape-conds (hcond iS') (<-Sâ‰¤ v')
Î â€²â‹† n [ i , h , t ]â†’[ 1+ h' , t' ] iS u iS' u' (on-height-width<max v v' w) A
  rewrite shape= iS' (shapeâ‚œâ†“ $ shape-conds (hcond iS') (<-Sâ‰¤ v'))
  = Î â€² _ (Î â€²â‹† n [ i , h , t ]â†’[ 1+ h' , 1+ t' ] iS u iS'' u' w A)
    where
    iS'' : is-shape i (1+ h') (1+ t')
    iS'' = shape-conds (hcond iS') (<-Sâ‰¤ v')

Ï€â‹†á´¹ n i iS iS' u u' w = {!!}

F O = U
F (1+ n) =
  Î â€²â‹† (1+ n) [ 1+ n , n , hom-size (1+ n) n ]â†’[ O , O ]
    (full-shape-1+ n) ltS (empty-shape (1+ n)) (O<S n)
    (OO[â‰¤â‚›] (full-shape-1+ n))  U
