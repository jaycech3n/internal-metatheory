{-# OPTIONS --without-K --rewriting #-}

open import cwfs.CwFs
open import cwfs.Pi
open import cwfs.Universe
open import reedy.IndexSemicategories

module reedy.ContextDiagrams {â„“â‚˜á´µ â„“â‚’ â„“â‚˜}
  (I : SuitableSemicategory â„“â‚˜á´µ)
  {C : WildCategory â„“â‚’ â„“â‚˜}
  (cwfstr : CwFStructure C)
  (pistr : PiStructure cwfstr)
  (univstr : UniverseStructure cwfstr)
  where

open import reedy.LinearSieves I
open SuitableSemicategory I
open CwFStructure cwfstr renaming (_â—¦_ to _â—¦Ë¢áµ˜áµ‡_)
open PiStructure pistr
open UniverseStructure univstr

interleaved mutual

  SCT : â„• â†’ Con
  M_[_,_,_] : (n i h t : â„•) â†’ is-shape i h t â†’ h < n â†’ Con
  Mâƒ—_[_,_,_] :
    (n i h t : â„•) (iS : is-shape i h t) (u : h < n)
    {m : â„•} (f : hom i m)
    {iSÂ· : is-shape-Î£ ([ i , h , t ] iS Â· f)}
    {uÂ· : 2nd ([ i , h , t ] iS Â· f) < n}
    â†’ let s = [ i , h , t ] iS Â· f in
      Sub (M n [ i , h , t ] iS u)
          (M n [ fst s , 2nd s , 3rd s ] iSÂ· uÂ·)
  -- Drops higher dimensional fillers
  Ï€â‹†Ë¢ : âˆ€ n h â†’ h < n â†’ Sub (SCT n) (SCT h)
  -- Projection from larger to smaller matching context drops components
  Ï€â‹†á´¹ : âˆ€ n i {h t h' t'} iS iS' u u'
    â†’ [ i , h' , t' ]â‰¤â‚›[ h , t ]
    â†’ Sub (M n [ i , h , t ] iS u) (M n [ i , h' , t' ] iS' u')
  Î â€²â‹†_[_,_,_]â†’[_,_] : âˆ€ n i h t h' t' iS u iS' u'
    â†’ [ i , h' , t' ]â‰¤â‚›[ h , t ]
    â†’ Ty (M n [ i , h , t ] iS u) â†’ Ty (M n [ i , h' , t' ] iS' u')
  F : (n : â„•) â†’ Ty (SCT n)
  ð’œ : âˆ€ n h u â†’ Tm[ SCT n ] (F h [ Ï€â‹†Ë¢ n h u ])

  SCT O = â—†
  SCT (1+ n) = SCT n âˆ· F n

  Ï€â‹†Ë¢ .(1+ h) h ltS = Ï€ (F h)
  Ï€â‹†Ë¢ (1+ n) h (ltSR u) = Ï€â‹†Ë¢ n h u â—¦Ë¢áµ˜áµ‡ Ï€ (F n)

  F O = U
  ð’œ .(1+ O) O ltS = var (SCT 1)
  ð’œ (1+ n) O (ltSR u) = coeáµ€áµ (! [â—¦]) $ ð’œ n O u Ê·â‚œ

  M 1 [ i , O , O ] _ _ = SCT 1
  M 1 [ i , O , 1+ t ] iS u =
    M 1 [ i , O , t ] iS' u
    âˆ· (ð’œ 1 O u [ Ï€â‹†á´¹ 1 i iS' (empty-shape i) u u (OO[â‰¤â‚›] iS') ]â‚œ
      â—‚$ coeáµ€áµ (! [â—¦] âˆ™ U[])
      â—‚$ el
      )
    where iS' = shapeâ‚œâ†“ iS
  M 1 [ i , 1+ h , t ] iS (ltSR ())

  Mâƒ— 1 [ i , h , t ] = {!!}

  Ï€â‹†á´¹ 1 i {O} {t} {O} {t'} iS iS' u u' done
    rewrite shape= iS' iS | <= u' u
    = id
  Ï€â‹†á´¹ 1 i {O} {t} {O} {t'} iS iS' u u' (on-width v w)
    rewrite shape= iS' {!!}
    = Ï€ _ â—¦Ë¢áµ˜áµ‡ Ï€â‹†á´¹ 1 i iS {!!} u u' w -- {!!}
  Ï€â‹†á´¹ 1 i {O} {_} {1+ _} iS iS' u (ltSR ())
  Ï€â‹†á´¹ 1 i {1+ _} iS iS' (ltSR ())

  Î â€²â‹† 1 [ i , O , t ]â†’[ O , .t ] iS u iS' u' done A
    rewrite shape= iS' iS | <= u' u
    = A
  Î â€²â‹† 1 [ i , O , t ]â†’[ O , t' ] iS u iS' u' (on-width v w) A
    rewrite shape= iS' (shapeâ‚œâ†“ $ shape-conds (Oâ‰¤ i) (<-Sâ‰¤ (<-â‰¤-< v (tcond iS))))
    = Î â€² _ (Î â€²â‹† 1 [ i , O , t ]â†’[ O , 1+ t' ] iS u iS'' u' w A)
    where
      iS'' : is-shape i O (1+ t')
      iS'' = shape-conds (Oâ‰¤ i) (<-Sâ‰¤ (<-â‰¤-< v (tcond iS)))
  Î â€²â‹† 1 [ i , 1+ _ , _ ]â†’[ _ , _ ] _ (ltSR ())
  Î â€²â‹† 1 [ i , _ , _ ]â†’[ 1+ _ , _ ] _ _ _ (ltSR ())

  F 1 = {!!}

  ð’œ n 1 u = {!!}


  M (2+ n) [ i , h , t ] = {!!}

  Mâƒ— (2+ n) [ i , h , t ] = {!!}

  Ï€â‹†á´¹ (2+ n) i iS iS' u u' x = {!!}

  Î â€²â‹† (2+ n) [ i , h , t ]â†’[ h' , t' ] = {!!}

  F (2+ n) = {!!}

  ð’œ n (2+ h) u = {!!}
