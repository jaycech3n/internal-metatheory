{-# OPTIONS --without-K --rewriting #-}

module cwfs.Contextual where

open import cwfs.CwFs

record LenStructure {â„“â‚’ â„“â‚˜} {C : WildCategory â„“â‚’ â„“â‚˜} (cwfstr : CwFStructure C)
  : Type (lsuc (â„“â‚’ âˆª â„“â‚˜)) where

  open CwFStructure cwfstr

  field
    len : Con â†’ â„•
    len-âˆ· : (Î“ : Con) (A : Ty Î“) â†’ len (Î“ âˆ· A) == 1+ (len Î“)

  âˆ·-len : âˆ€ n â†’ Î£[ Î“ Ë Con ] Ty Î“ Ã— (len Î“ == n) â†’ Î£[ Î“ Ë Con ] len Î“ == 1+ n
  âˆ·-len _ (Î“ , A , idp) = (Î“ âˆ· A) , len-âˆ· Î“ A

record ContextualStructure {â„“â‚’ â„“â‚˜} {C : WildCategory â„“â‚’ â„“â‚˜} (cwfstr : CwFStructure C)
  : Type (lsuc (â„“â‚’ âˆª â„“â‚˜)) where

  field lenstr : LenStructure cwfstr
  open LenStructure lenstr
  open CwFStructure cwfstr

  field
    len-â—†-equiv : âˆ€ {Î“} â†’ (Î“ == â—†) â‰ƒ (len Î“ == O)
      -- Do we actually need it to be this strong?
      -- What about just (len â—† == O) Ã— (len Î“ == O â†’ Î“ == â—†)?
      -- A : You do need this; see Con-codes in cwfs.contextual.CwFs
    len-âˆ·-equiv : âˆ€ {n} â†’ is-equiv (âˆ·-len n)

  len-â—† : len â—† == O
  len-â—† = â€“> len-â—†-equiv idp

  private
    module context-operations where
      dest-context :
        âˆ€ {n} (Î“ : Con) â†’ len Î“ == 1+ n â†’ Î£[ Î” Ë Con ] Ty Î” Ã— (len Î” == n)
      dest-context = curry (inv-equiv len-âˆ·-equiv)

      split-context :
        âˆ€ {n} (Î“ : Con) â†’ len Î“ == 1+ n â†’ Î£[ Î” Ë Con ] Ty Î”
      split-context Î“ p = first-two (dest-context Î“ p)

  open context-operations

  {-
  coná¶œ-of : âˆ€ {n} â†’ (Î“ : Con) â†’ â¦ƒ len Î“ == n â¦„ â†’ Coná¶œ n
  con-coná¶œ : âˆ€ {n} â†’ (Î“ : Con) â†’ â¦ƒ p : len Î“ == n â¦„ â†’ Î“ == con-of (coná¶œ-of Î“)

  coná¶œ-of {O} Î“ = lift tt
  coná¶œ-of {1+ n} Î“ â¦ƒ p â¦„ = coná¶œ-of Î” , transp Ty (con-coná¶œ Î”) A
    where
    Î”Aq = dest-context Î“ p
    Î” = fst Î”Aq
    A = 2nd Î”Aq
    instance q = 3rd Î”Aq

  con-coná¶œ {O} Î“ â¦ƒ p â¦„ = <â€“ len-â—†-equiv p
  con-coná¶œ {1+ n} Î“ â¦ƒ p â¦„ = {!-- switching to another formulation for now,
    but should figure out whether this is actually provable!}
  -}

module Contextual-contextual-core {â„“â‚’ â„“â‚˜} {C : WildCategory â„“â‚’ â„“â‚˜} (cwf : CwFStructure C)
  where

  -- Given a CwF ğ’, the sub-CwF on the contexts generated by â—† and
  -- âˆ· is a contextual CwF. We call this the *contextual core* of ğ’.

  open CwFStructure cwf

  -- (Isomorphic to the) Subcategory of C inductively generated by â—† and âˆ·
  Cá¶œ : WildCategory â„“â‚’ â„“â‚˜
  WildCategory.Ob Cá¶œ = Î£[ n Ë â„• ] Coná¶œ n
  WildCategory.wildcatstr Cá¶œ = record
    { wildsemicatstr = record
        { hom = Î»{ (_ , Î³) (_ , Î´) â†’ Sub (con-of Î³) (con-of Î´) }
        ; _â—¦_ = _â—¦_
        ; ass = ass }
    ; id = id
    ; idl = idl
    ; idr = idr }

  ctxstrá¶œ : ContextStructure Cá¶œ
  ctxstrá¶œ = record
    { â—† = O , lift unit
    ; â—†-terminal = Î»{ (_ , Î³) â†’ â—†-terminal (con-of Î³) } }

  open ContextStructure ctxstrá¶œ

  tytmstrá¶œ : TyTmStructure Cá¶œ
  tytmstrá¶œ = record
    { ctxstr = ctxstrá¶œ
    ; Ty = Î»{ (_ , Î³) â†’ Ty (con-of Î³) }
    ; _[_] = _[_]
    ; [id] = [id]
    ; [â—¦] = [â—¦]
    ; Tm = Tm
    ; _[_]â‚œ = _[_]â‚œ
    ; [id]â‚œ = [id]â‚œ
    ; [â—¦]â‚œ = [â—¦]â‚œ }

  coeáµ€áµá¶œ= :
    {Î“ @ (n , Î³) : ContextStructure.Con ctxstrá¶œ}
    {A A' : Ty (con-of Î³)}
    (p : A == A') (t : Tm A)
    â†’ TyTmStructure.coeáµ€áµ tytmstrá¶œ {Î“} p t == coeáµ€áµ p t
  coeáµ€áµá¶œ= idp t = idp

  cwfstrá¶œ : CwFStructure Cá¶œ
  CwFStructure.compstr cwfstrá¶œ = record
    { tytmstr = tytmstrá¶œ
    ; _âˆ·_ = Î» (n , Î³) A â†’ 1+ n , Î³ , A
    ; Ï€ = Ï€
    ; Ï… = Ï…
    ; _,,_ = _,,_
    ; Î²Ï€ = Î²Ï€
    ; Î²Ï… = Î²Ï…
    ; Î·,, = Î·,,
    ; ,,-â—¦ = ,,-â—¦ âˆ™ âŸ¨=,, ! (coeáµ€áµá¶œ= (! [â—¦]) _) =âŸ© }

  lenstrá¶œ : LenStructure cwfstrá¶œ
  LenStructure.len lenstrá¶œ = fst
  LenStructure.len-âˆ· lenstrá¶œ Î“ A = idp

  ContextualCoreStructure : ContextualStructure cwfstrá¶œ
  ContextualStructure.lenstr ContextualCoreStructure = lenstrá¶œ
  ContextualStructure.len-â—†-equiv ContextualCoreStructure =
    equiv (Î»{ idp â†’ idp }) (Î»{ idp â†’ idp }) (Î»{ idp â†’ idp }) (Î»{ idp â†’ idp })
  ContextualStructure.len-âˆ·-equiv ContextualCoreStructure {n} =
    is-eq (âˆ·-len n)
      (Î»{ ((_ , Î³ , A) , idp) â†’ (n , Î³) , A , idp })
      (Î»{ ((_ , Î³) , idp) â†’ idp })
      (Î»{ ((_ , Î³) , A , idp) â†’ idp })
    where open LenStructure lenstrá¶œ using (âˆ·-len)
